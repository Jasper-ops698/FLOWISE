"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ExperimentalMomentoLocalMiddlewareRequestHandler = exports.ExperimentalMomentoLocalTestConfigMiddleware = void 0;
const momento_error_code_metadata_converter_1 = require("../retry/momento-error-code-metadata-converter");
const momento_rpc_method_1 = require("../retry/momento-rpc-method");
class ExperimentalMomentoLocalMiddlewareRequestHandler {
    constructor(metadata) {
        this.metadata = metadata;
    }
    onRequestBody(request) {
        return Promise.resolve(request);
    }
    onRequestMetadata(metadata) {
        const grpcMetadata = metadata._grpcMetadata;
        for (const [key, value] of Object.entries(this.metadata)) {
            this.setGrpcMetadata(grpcMetadata, key, value);
        }
        return Promise.resolve(metadata);
    }
    onResponseMetadata(metadata) {
        return Promise.resolve(metadata);
    }
    onResponseBody(response) {
        return Promise.resolve(response);
    }
    onResponseStatus(status) {
        return Promise.resolve(status);
    }
    setGrpcMetadata(metadata, key, value) {
        if (value === undefined)
            return;
        let convertedKey;
        let convertedValue;
        switch (key) {
            case 'requestId':
                convertedKey = 'request-id';
                convertedValue = value;
                break;
            case 'returnError':
                convertedKey = 'return-error';
                convertedValue = momento_error_code_metadata_converter_1.MomentoErrorCodeMetadataConverter.convert(value);
                break;
            case 'errorRpcs':
                convertedKey = 'error-rpcs';
                convertedValue = value
                    .map(rpcMethod => momento_rpc_method_1.MomentoRPCMethodMetadataConverter.convert(rpcMethod))
                    .join(' ');
                break;
            case 'errorCount':
                convertedKey = 'error-count';
                convertedValue = value.toString();
                break;
            case 'delayRpcs':
                convertedKey = 'delay-rpcs';
                convertedValue = value
                    .map(rpcMethod => momento_rpc_method_1.MomentoRPCMethodMetadataConverter.convert(rpcMethod))
                    .join(' ');
                break;
            case 'delayMs':
                convertedKey = 'delay-ms';
                convertedValue = value.toString();
                break;
            case 'delayCount':
                convertedKey = 'delay-count';
                convertedValue = value.toString();
                break;
            default:
                convertedKey = key;
                convertedValue = value;
        }
        metadata.set(convertedKey, convertedValue);
    }
}
exports.ExperimentalMomentoLocalMiddlewareRequestHandler = ExperimentalMomentoLocalMiddlewareRequestHandler;
class ExperimentalMomentoLocalTestConfigMiddleware {
    constructor(metadata) {
        this.shouldLoadLate = true;
        this.metadata = metadata;
    }
    onNewRequest() {
        return new ExperimentalMomentoLocalMiddlewareRequestHandler(this.metadata);
    }
}
exports.ExperimentalMomentoLocalTestConfigMiddleware = ExperimentalMomentoLocalTestConfigMiddleware;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwZXJpbWVudGFsLW1vbWVudG8tbG9jYWwtdGVzdC1jb25maWctbWlkZGxld2FyZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb25maWcvbWlkZGxld2FyZS9leHBlcmltZW50YWwtbW9tZW50by1sb2NhbC10ZXN0LWNvbmZpZy1taWRkbGV3YXJlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQVFBLDBHQUFpRztBQUNqRyxvRUFBOEU7QUFFOUUsTUFBTSxnREFBZ0Q7SUFJcEQsWUFBWSxRQUFvRDtRQUM5RCxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztJQUMzQixDQUFDO0lBRUQsYUFBYSxDQUFDLE9BQTBCO1FBQ3RDLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBRUQsaUJBQWlCLENBQUMsUUFBNEI7UUFDNUMsTUFBTSxZQUFZLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQztRQUM1QyxLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDeEQsSUFBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLEVBQUUsR0FBRyxFQUFFLEtBQWUsQ0FBQyxDQUFDO1NBQzFEO1FBQ0QsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFRCxrQkFBa0IsQ0FDaEIsUUFBNEI7UUFFNUIsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFRCxjQUFjLENBQ1osUUFBa0M7UUFFbEMsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFRCxnQkFBZ0IsQ0FBQyxNQUF3QjtRQUN2QyxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDakMsQ0FBQztJQUVPLGVBQWUsQ0FDckIsUUFBa0IsRUFDbEIsR0FBVyxFQUNYLEtBQWU7UUFFZixJQUFJLEtBQUssS0FBSyxTQUFTO1lBQUUsT0FBTztRQUVoQyxJQUFJLFlBQW9CLENBQUM7UUFDekIsSUFBSSxjQUFzQixDQUFDO1FBRTNCLFFBQVEsR0FBRyxFQUFFO1lBQ1gsS0FBSyxXQUFXO2dCQUNkLFlBQVksR0FBRyxZQUFZLENBQUM7Z0JBQzVCLGNBQWMsR0FBRyxLQUFlLENBQUM7Z0JBQ2pDLE1BQU07WUFDUixLQUFLLGFBQWE7Z0JBQ2hCLFlBQVksR0FBRyxjQUFjLENBQUM7Z0JBQzlCLGNBQWMsR0FBRyx5RUFBaUMsQ0FBQyxPQUFPLENBQ3hELEtBQWUsQ0FDaEIsQ0FBQztnQkFDRixNQUFNO1lBQ1IsS0FBSyxXQUFXO2dCQUNkLFlBQVksR0FBRyxZQUFZLENBQUM7Z0JBQzVCLGNBQWMsR0FBSSxLQUFrQjtxQkFDakMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQ2Ysc0RBQWlDLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUNyRDtxQkFDQSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2IsTUFBTTtZQUNSLEtBQUssWUFBWTtnQkFDZixZQUFZLEdBQUcsYUFBYSxDQUFDO2dCQUM3QixjQUFjLEdBQUksS0FBZ0IsQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDOUMsTUFBTTtZQUNSLEtBQUssV0FBVztnQkFDZCxZQUFZLEdBQUcsWUFBWSxDQUFDO2dCQUM1QixjQUFjLEdBQUksS0FBa0I7cUJBQ2pDLEdBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUNmLHNEQUFpQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FDckQ7cUJBQ0EsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNiLE1BQU07WUFDUixLQUFLLFNBQVM7Z0JBQ1osWUFBWSxHQUFHLFVBQVUsQ0FBQztnQkFDMUIsY0FBYyxHQUFJLEtBQWdCLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQzlDLE1BQU07WUFDUixLQUFLLFlBQVk7Z0JBQ2YsWUFBWSxHQUFHLGFBQWEsQ0FBQztnQkFDN0IsY0FBYyxHQUFJLEtBQWdCLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQzlDLE1BQU07WUFDUjtnQkFDRSxZQUFZLEdBQUcsR0FBRyxDQUFDO2dCQUNuQixjQUFjLEdBQUcsS0FBZSxDQUFDO1NBQ3BDO1FBRUQsUUFBUSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUUsY0FBYyxDQUFDLENBQUM7SUFDN0MsQ0FBQztDQUNGO0FBNEJDLDRHQUFnRDtBQWhCbEQsTUFBTSw0Q0FBNEM7SUFHaEQsWUFBWSxRQUFvRDtRQUM5RCxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQztRQUMzQixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztJQUMzQixDQUFDO0lBRUQsWUFBWTtRQUNWLE9BQU8sSUFBSSxnREFBZ0QsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDN0UsQ0FBQztDQUNGO0FBR0Msb0dBQTRDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtNZXRhZGF0YX0gZnJvbSAnQGdycGMvZ3JwYy1qcyc7XG5pbXBvcnQge1xuICBNaWRkbGV3YXJlLFxuICBNaWRkbGV3YXJlTWVzc2FnZSxcbiAgTWlkZGxld2FyZU1ldGFkYXRhLFxuICBNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXIsXG4gIE1pZGRsZXdhcmVTdGF0dXMsXG59IGZyb20gJy4vbWlkZGxld2FyZSc7XG5pbXBvcnQge01vbWVudG9FcnJvckNvZGVNZXRhZGF0YUNvbnZlcnRlcn0gZnJvbSAnLi4vcmV0cnkvbW9tZW50by1lcnJvci1jb2RlLW1ldGFkYXRhLWNvbnZlcnRlcic7XG5pbXBvcnQge01vbWVudG9SUENNZXRob2RNZXRhZGF0YUNvbnZlcnRlcn0gZnJvbSAnLi4vcmV0cnkvbW9tZW50by1ycGMtbWV0aG9kJztcblxuY2xhc3MgRXhwZXJpbWVudGFsTW9tZW50b0xvY2FsTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyXG4gIGltcGxlbWVudHMgTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyXG57XG4gIHByaXZhdGUgcmVhZG9ubHkgbWV0YWRhdGE6IEV4cGVyaW1lbnRhbE1vbWVudG9Mb2NhbFRlc3RDb25maWdNZXRhZGF0YTtcbiAgY29uc3RydWN0b3IobWV0YWRhdGE6IEV4cGVyaW1lbnRhbE1vbWVudG9Mb2NhbFRlc3RDb25maWdNZXRhZGF0YSkge1xuICAgIHRoaXMubWV0YWRhdGEgPSBtZXRhZGF0YTtcbiAgfVxuXG4gIG9uUmVxdWVzdEJvZHkocmVxdWVzdDogTWlkZGxld2FyZU1lc3NhZ2UpOiBQcm9taXNlPE1pZGRsZXdhcmVNZXNzYWdlPiB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXF1ZXN0KTtcbiAgfVxuXG4gIG9uUmVxdWVzdE1ldGFkYXRhKG1ldGFkYXRhOiBNaWRkbGV3YXJlTWV0YWRhdGEpOiBQcm9taXNlPE1pZGRsZXdhcmVNZXRhZGF0YT4ge1xuICAgIGNvbnN0IGdycGNNZXRhZGF0YSA9IG1ldGFkYXRhLl9ncnBjTWV0YWRhdGE7XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXModGhpcy5tZXRhZGF0YSkpIHtcbiAgICAgIHRoaXMuc2V0R3JwY01ldGFkYXRhKGdycGNNZXRhZGF0YSwga2V5LCB2YWx1ZSBhcyBzdHJpbmcpO1xuICAgIH1cbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG1ldGFkYXRhKTtcbiAgfVxuXG4gIG9uUmVzcG9uc2VNZXRhZGF0YShcbiAgICBtZXRhZGF0YTogTWlkZGxld2FyZU1ldGFkYXRhXG4gICk6IFByb21pc2U8TWlkZGxld2FyZU1ldGFkYXRhPiB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShtZXRhZGF0YSk7XG4gIH1cblxuICBvblJlc3BvbnNlQm9keShcbiAgICByZXNwb25zZTogTWlkZGxld2FyZU1lc3NhZ2UgfCBudWxsXG4gICk6IFByb21pc2U8TWlkZGxld2FyZU1lc3NhZ2UgfCBudWxsPiB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXNwb25zZSk7XG4gIH1cblxuICBvblJlc3BvbnNlU3RhdHVzKHN0YXR1czogTWlkZGxld2FyZVN0YXR1cyk6IFByb21pc2U8TWlkZGxld2FyZVN0YXR1cz4ge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoc3RhdHVzKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0R3JwY01ldGFkYXRhKFxuICAgIG1ldGFkYXRhOiBNZXRhZGF0YSxcbiAgICBrZXk6IHN0cmluZyxcbiAgICB2YWx1ZT86IHVua25vd25cbiAgKTogdm9pZCB7XG4gICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjtcblxuICAgIGxldCBjb252ZXJ0ZWRLZXk6IHN0cmluZztcbiAgICBsZXQgY29udmVydGVkVmFsdWU6IHN0cmluZztcblxuICAgIHN3aXRjaCAoa2V5KSB7XG4gICAgICBjYXNlICdyZXF1ZXN0SWQnOlxuICAgICAgICBjb252ZXJ0ZWRLZXkgPSAncmVxdWVzdC1pZCc7XG4gICAgICAgIGNvbnZlcnRlZFZhbHVlID0gdmFsdWUgYXMgc3RyaW5nO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3JldHVybkVycm9yJzpcbiAgICAgICAgY29udmVydGVkS2V5ID0gJ3JldHVybi1lcnJvcic7XG4gICAgICAgIGNvbnZlcnRlZFZhbHVlID0gTW9tZW50b0Vycm9yQ29kZU1ldGFkYXRhQ29udmVydGVyLmNvbnZlcnQoXG4gICAgICAgICAgdmFsdWUgYXMgc3RyaW5nXG4gICAgICAgICk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnZXJyb3JScGNzJzpcbiAgICAgICAgY29udmVydGVkS2V5ID0gJ2Vycm9yLXJwY3MnO1xuICAgICAgICBjb252ZXJ0ZWRWYWx1ZSA9ICh2YWx1ZSBhcyBzdHJpbmdbXSlcbiAgICAgICAgICAubWFwKHJwY01ldGhvZCA9PlxuICAgICAgICAgICAgTW9tZW50b1JQQ01ldGhvZE1ldGFkYXRhQ29udmVydGVyLmNvbnZlcnQocnBjTWV0aG9kKVxuICAgICAgICAgIClcbiAgICAgICAgICAuam9pbignICcpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2Vycm9yQ291bnQnOlxuICAgICAgICBjb252ZXJ0ZWRLZXkgPSAnZXJyb3ItY291bnQnO1xuICAgICAgICBjb252ZXJ0ZWRWYWx1ZSA9ICh2YWx1ZSBhcyBudW1iZXIpLnRvU3RyaW5nKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnZGVsYXlScGNzJzpcbiAgICAgICAgY29udmVydGVkS2V5ID0gJ2RlbGF5LXJwY3MnO1xuICAgICAgICBjb252ZXJ0ZWRWYWx1ZSA9ICh2YWx1ZSBhcyBzdHJpbmdbXSlcbiAgICAgICAgICAubWFwKHJwY01ldGhvZCA9PlxuICAgICAgICAgICAgTW9tZW50b1JQQ01ldGhvZE1ldGFkYXRhQ29udmVydGVyLmNvbnZlcnQocnBjTWV0aG9kKVxuICAgICAgICAgIClcbiAgICAgICAgICAuam9pbignICcpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2RlbGF5TXMnOlxuICAgICAgICBjb252ZXJ0ZWRLZXkgPSAnZGVsYXktbXMnO1xuICAgICAgICBjb252ZXJ0ZWRWYWx1ZSA9ICh2YWx1ZSBhcyBudW1iZXIpLnRvU3RyaW5nKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnZGVsYXlDb3VudCc6XG4gICAgICAgIGNvbnZlcnRlZEtleSA9ICdkZWxheS1jb3VudCc7XG4gICAgICAgIGNvbnZlcnRlZFZhbHVlID0gKHZhbHVlIGFzIG51bWJlcikudG9TdHJpbmcoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBjb252ZXJ0ZWRLZXkgPSBrZXk7XG4gICAgICAgIGNvbnZlcnRlZFZhbHVlID0gdmFsdWUgYXMgc3RyaW5nO1xuICAgIH1cblxuICAgIG1ldGFkYXRhLnNldChjb252ZXJ0ZWRLZXksIGNvbnZlcnRlZFZhbHVlKTtcbiAgfVxufVxuXG5pbnRlcmZhY2UgRXhwZXJpbWVudGFsTW9tZW50b0xvY2FsVGVzdENvbmZpZ01ldGFkYXRhIHtcbiAgcmVxdWVzdElkOiBzdHJpbmc7XG4gIHJldHVybkVycm9yPzogc3RyaW5nO1xuICBlcnJvclJwY3M/OiBzdHJpbmdbXTtcbiAgZXJyb3JDb3VudD86IG51bWJlcjtcbiAgZGVsYXlScGNzPzogc3RyaW5nW107XG4gIGRlbGF5TXM/OiBudW1iZXI7XG4gIGRlbGF5Q291bnQ/OiBudW1iZXI7XG59XG5cbmNsYXNzIEV4cGVyaW1lbnRhbE1vbWVudG9Mb2NhbFRlc3RDb25maWdNaWRkbGV3YXJlIGltcGxlbWVudHMgTWlkZGxld2FyZSB7XG4gIHNob3VsZExvYWRMYXRlOiBib29sZWFuO1xuICBwcml2YXRlIHJlYWRvbmx5IG1ldGFkYXRhOiBFeHBlcmltZW50YWxNb21lbnRvTG9jYWxUZXN0Q29uZmlnTWV0YWRhdGE7XG4gIGNvbnN0cnVjdG9yKG1ldGFkYXRhOiBFeHBlcmltZW50YWxNb21lbnRvTG9jYWxUZXN0Q29uZmlnTWV0YWRhdGEpIHtcbiAgICB0aGlzLnNob3VsZExvYWRMYXRlID0gdHJ1ZTtcbiAgICB0aGlzLm1ldGFkYXRhID0gbWV0YWRhdGE7XG4gIH1cblxuICBvbk5ld1JlcXVlc3QoKTogTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyIHtcbiAgICByZXR1cm4gbmV3IEV4cGVyaW1lbnRhbE1vbWVudG9Mb2NhbE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcih0aGlzLm1ldGFkYXRhKTtcbiAgfVxufVxuXG5leHBvcnQge1xuICBFeHBlcmltZW50YWxNb21lbnRvTG9jYWxUZXN0Q29uZmlnTWlkZGxld2FyZSxcbiAgRXhwZXJpbWVudGFsTW9tZW50b0xvY2FsVGVzdENvbmZpZ01ldGFkYXRhLFxuICBFeHBlcmltZW50YWxNb21lbnRvTG9jYWxNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXIsXG59O1xuIl19